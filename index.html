<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación de Escritura Creativa</title>
    <!-- Incluye el CDN de Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye los iconos de Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .main-card {
            background-color: #161b22;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 32rem;
            width: 100%;
            text-align: center;
            margin: auto;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #3b82f6, #4f46e5);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            transform: scale(1.05);
        }
        .btn-secondary {
            background-color: #4b5563;
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: transform 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #6b7280;
            transform: scale(1.05);
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: transform 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #ef4444;
            transform: scale(1.05);
        }
        .grid-plots {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .plot-card {
            background-color: #1f2937;
            border-width: 4px;
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            transition: transform 0.3s ease-in-out;
            cursor: pointer;
        }
        .plot-card:hover {
            transform: scale(1.05);
        }
        .spinning-placeholder {
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        /* Media queries para que el tamaño de la fuente se adapte a la pantalla */
        @media (min-width: 640px) {
            .spinning-placeholder {
                font-size: 1rem;
                line-height: 1.5rem;
            }
        }
        @media (min-width: 768px) {
            .spinning-placeholder {
                font-size: 1.125rem;
                line-height: 1.75rem;
            }
        }
        .movable-timer {
            position: fixed;
            cursor: move;
            z-index: 1000;
        }
        .fixed-sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            width: 25%;
            padding: 2rem;
            background-color: #161b22;
            overflow-y: auto;
        }
        .main-content {
            margin-left: 25%;
            width: 75%;
            padding: 2.5rem;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased">
    <div id="app"></div>

    <script>
        // Datos de la aplicación
        const PROTAGONISTAS = [ "Un/a fotógrafo/a de fenómenos paranormales", "Un/a periodista de sucesos", "Un/a detective aficionado/a", "Un/a repartidor/a nocturno/a", "Un/a vigilante de museo", "Un/a estudiante de arqueología", "Un/a explorador/a de cuevas", "Un/a técnico/a de mantenimiento del metro", "Un/a guía turístico/a en ruinas históricas", "Un/a coleccionista de objetos malditos", "Un/a radioaficionado/a solitario/a", "Un/a piloto de drones", "Un/a investigador/a de crímenes antiguos", "Un/a aficionado/a a la fotografía analógica", "Un/a ex-policía retirado/a", "Un/a conductor/a de autobús nocturno", "Un/a chef en un restaurante apartado", "Un/a estudiante de intercambio", "Un/a cuidador/a de faro", "Un/a creador/a de podcasts de misterio", "Un/a astrónomo/a amateur", "Un/a paramédico/a", "Un/a voluntario/a de la Cruz Roja", "Un/a excursionista solitario/a", "Un/a anticuario/a", "Un/a marinero/a de carga", "Un/a taxista de ciudad portuaria", "Un/a mecánico/a en un taller rural", "Un/a vendedor/a ambulante", "Un/a agente inmobiliario/a", "Un/a estudiante de arte", "Un/a hacker ético/a", "Un/a blogger de viajes", "Un/a refugiado/a", "Un/a buscador/a de tesoros", "Un/a camarógrafo/a de documentales", "Un/a guardaparques", "Un/a rescatista de montaña", "Un/a cuidador/a de cementerio", "Un/a pintor/a bohemio/a", "Un/a aprendiz de mago", "Un/a investigador/a universitario/a", "Un/a arqueólogo/a subacuático/a", "Un/a guardia de prisión", "Un/a conductor/a de tren", "Un/a restaurador/a de arte", "Un/a psíquico/a televisivo/a", "Un/a mochilero/a", "Un/a paramilitar retirado/a", "Un/a doctor/a rural" ];
        const ESCENARIOS = [ "Un túnel ferroviario clausurado", "Un faro en medio de la tormenta", "Un cine abandonado", "Un hospital en cuarentena", "Una mansión victoriana", "Un laboratorio subterráneo", "Una escuela cerrada por décadas", "Un puerto pesquero desierto", "Una carretera sin fin", "Un aeropuerto olvidado", "Un monasterio en ruinas", "Un circo desmantelado", "Un mirador en la montaña", "Un castillo en la niebla", "Un búnker de guerra", "Un centro comercial abandonado", "Un campamento minero", "Una playa cubierta de niebla", "Un pantano solitario", "Un observatorio antiguo", "Una isla sin habitantes", "Un mercado nocturno", "Un puente colgante en mal estado", "Un túnel de servicios bajo la ciudad", "Un cementerio olvidado", "Un paso de montaña nevado", "Un bosque petrificado", "Un barco encallado", "Un cañón desértico", "Un barrio fantasma", "Un parque nacional cerrado", "Un jardín botánico abandonado", "Una presa inactiva", "Un cráter de meteorito", "Un refugio antinuclear", "Una plaza colonial vacía", "Una estación polar", "Un museo cerrado al público", "Un pueblo minero fantasma", "Un bosque de bambú", "Una base militar abandonada", "Un callejón sin salida", "Una autopista elevada", "Una fábrica en ruinas", "Un santuario olvidado", "Un lago congelado", "Un paso subterráneo inundado", "Un viejo matadero", "Un viaducto ferroviario" ];
        const DETONANTES = [ "Un mensaje en una botella que aparece cada día", "Una radio que transmite voces antiguas", "Una sombra que te sigue incluso de día", "Una puerta que aparece en sitios distintos", "Un reloj que marca horas inexistentes", "Un cuaderno que escribe solo", "Un espejo que muestra otro lugar", "Un susurro detrás de la oreja", "Un animal que no deja de observarte", "Una carta sin remitente que cambia de texto", "Un olor a quemado sin fuego", "Una risa en una habitación vacía", "Un pozo del que provienen cantos", "Un objeto que siempre regresa a tu bolsillo", "Una silueta detrás de una ventana cerrada", "Un teléfono que llama desde tu propio número", "Una sombra que no coincide con tu movimiento", "Un mapa que dibuja rutas nuevas", "Una fotografía donde aparece alguien más", "Una voz que dice tu nombre en la multitud", "Un viento que susurra palabras", "Un sonido metálico en la madrugada", "Una estatua que cambia de posición", "Una puerta que se abre sola", "Un latido en las paredes", "Una caja fuerte que se abre sola", "Un cuadro que cambia de imagen", "Un objeto que se calienta sin motivo", "Un mensaje escrito en el espejo empañado", "Un eco que responde distinto", "Un canto que solo se oye bajo el agua", "Una lámpara que parpadea en código", "Una llave que abre cualquier puerta", "Un destello en la oscuridad", "Un animal que habla en sueños", "Un olor a flores inexistentes", "Un zapato en medio del camino", "Un anillo que aprieta por sí solo", "Un paso detrás de ti sin nadie", "Un grito ahogado en el viento", "Un papel con tu letra que no recuerdas haber escrito", "Un silbido repetitivo en la noche", "Unos olhos brillando en la oscuridad", "Una figura que siempre aparece en tus fotos", "Un pitido que solo tú escuchas", "Una piedra que se mueve sola", "Un llanto detrás de una pared", "Un crujido que se acerca cada noche", "Un nombre escrito en la arena que no conoces" ];

        // Array de títulos estáticos para la guía de escritura
        const GUIA_ESCRITURA_STEPS = [ "1. La Introducción", "2. El Nudo", "3. El Clímax", "4. El Desenlace" ];
        
        // Datos de instrucciones y pistas para la guía de escritura
        const GUIA_ESCRITURA_OPTIONS = {
            "1. La Introducción": {
                instrucciones: [
                    "Toma tu papel y bolígrafo. Describe el escenario. ¿Cómo es? ¿Qué oye tu protagonista? Presenta a tu personaje. ¿Es su primera vez allí o es un veterano?",
                    "Establece la escena y a tu protagonista. Describe el entorno con detalle, incluyendo los sonidos y olores que percibe el personaje. ¿Qué le trajo aquí?",
                    "Comienza con tu protagonista ya en el escenario. ¿Qué está haciendo? ¿Cómo se siente? Usa los primeros párrafos para crear una atmósfera de misterio.",
                    "Elige un punto de vista (primera o tercera persona) y describe el lugar a través de los ojos de tu personaje. ¿Qué ve que le resulta extraño o familiar?",
                    "Presenta a tu personaje principal con sus miedos y motivaciones. ¿Qué lo hace vulnerable? ¿Qué lo hace peligroso? El escenario debe reflejar este estado de ánimo.",
                    "Empieza con una acción. Tu protagonista está investigando o huyendo. Usa los flashbacks o el diálogo interno para revelar la información del entorno.",
                    "Describe el escenario como si fuera un personaje más. ¿Qué secretos esconde? ¿Cómo interactúa el entorno con tu protagonista?",
                    "Usa un contraste. El protagonista es alegre y el escenario lúgubre, o viceversa. ¿Qué pasa cuando estas dos fuerzas chocan?",
                    "Crea una sensación de 'calma antes de la tormenta'. Describe el escenario con una normalidad que sabes que está a punto de romperse. Introduce a tu protagonista.",
                    "Comienza con un sonido o un olor que desorienta al protagonista. ¿De dónde viene? ¿Qué reacción provoca? Luego, describe el escenario."
                ],
                pistas: [
                    "Usa al menos tres de los cinco sentidos. ¿Huele a polvo? ¿El suelo de madera cruje? ¿La única luz es la de su linterna?",
                    "Piensa en el 'show, don't tell'. En lugar de decir 'el lugar era espeluznante', describe las telarañas, el eco y la oscuridad.",
                    "Elige una emoción principal para tu protagonista y haz que el entorno la intensifique. Si tiene miedo, que haya sombras; si está solo, que el espacio sea vasto.",
                    "Juega con la iluminación. Una farola parpadeante, la luz de la luna o un reflejo en el metal pueden ser claves en la atmósfera.",
                    "Elige un detalle concreto del escenario y dale importancia. Un objeto viejo, una mancha en la pared, un sonido lejano. ¿Qué significa?",
                    "Introduce el tema de la historia sin revelarlo. Si es sobre fantasmas, haz que tu protagonista sienta un escalofrío inexplicable.",
                    "La introducción debe plantear una pregunta. ¿Qué va a pasar? ¿Quién es este personaje? ¿Qué es este lugar? No la respondas aún.",
                    "Usa el clima a tu favor. Niebla, lluvia o una noche sin estrellas pueden aumentar la sensación de aislamiento y miedo.",
                    "Evita descripciones genéricas. En lugar de 'era una casa vieja', intenta 'era una casa vieja cuyas ventanas rotas parecían ojos huecos'.",
                    "El primer párrafo es crucial. Capta la atención del lector con un detalle intrigante, una frase fuerte o un misterio sin resolver."
                ]
            },
            "2. El Nudo": {
                instrucciones: [
                    "Es el momento de que ocurra algo. Tu protagonista encuentra 'El Detonante'. ¿Cómo lo encuentra? ¿Qué hace? Escribe la escena. ¡Haz que tome una decisión arriesgada!",
                    "Tu protagonista se enfrenta al detonante. ¿Lo ignora o decide investigar? ¿Por qué toma esa decisión? Aumenta la tensión poco a poco, no todo de golpe.",
                    "El detonante provoca una reacción. Tu protagonista no está solo; puede que un ser o una fuerza extraña haya notado su presencia. Describe la interacción.",
                    "El detonante es el primer indicio de que algo no anda bien. ¿Qué otras señales empiezan a manifestarse? Haz que el protagonista se cuestione su cordura.",
                    "Elige un segundo personaje o un obstáculo que impida al protagonista llegar al detonante. ¿Cómo lo sortea? ¿Qué precio paga por seguir adelante?",
                    "Describe el detonante en detalle. ¿Qué aspecto tiene? ¿Qué sonido emite? ¿Qué sensación produce? Escribe cómo el protagonista se acerca a él y lo manipula.",
                    "El detonante es un recuerdo o una revelación que el protagonista había reprimido. ¿Qué le hace sentir? ¿Cómo cambia su percepción de lo que está pasando?",
                    "El protagonista encuentra el detonante por accidente. Un resbalón, una caída. ¿Qué sucede en el momento exacto del descubrimiento? ¿Es un antes y un después?",
                    "Usa una cuenta atrás. El protagonista tiene un tiempo limitado para llegar al detonante. ¿Cómo maneja la presión? ¿Qué obstáculos se interponen en su camino?",
                    "El detonante es algo que el protagonista pensaba que no existía. Describe el momento de la incredulidad y la posterior aceptación de una nueva realidad."
                ],
                pistas: [
                    "El diálogo interno es tu amigo. Haz que el personaje hable solo. 'No debería... pero... ¿y si...?'",
                    "Aumenta la tensión. Un chirrido, una luz parpadeante. Usa pequeñas pistas para generar anticipación antes de la gran revelación.",
                    "La decisión del protagonista de acercarse al detonante debe tener un motivo, incluso si es solo la curiosidad. Asegúrate de que su decisión sea coherente con su personalidad.",
                    "Piensa en las consecuencias del detonante. Si es un sonido, que el sonido se repita. Si es un objeto, que se mueva o cambie.",
                    "Usa la acción para describir los sentimientos del personaje. Si tiene miedo, que sus manos tiemblen; si está fascinado, que se olvide de respirar.",
                    "No reveles todo. El detonante debe ser un misterio en sí mismo que plantee más preguntas de las que responde.",
                    "Crea una sensación de claustrofobia o agorafobia. Si están en un espacio pequeño, que la caja sea pesada; si están en uno grande, que el eco sea interminable.",
                    "La música de fondo. Piensa en el 'sonido' de la escena. Un silencio total, un zumbido constante, el sonido de su propia respiración.",
                    "La interacción con el detonante debe ser una escalada. Primero, lo ve. Luego, lo toca. Finalmente, el detonante lo afecta de alguna manera.",
                    "No tengas miedo de hacer que tu personaje cometa un error. Que un tropiezo revele algo o que una decisión impulsiva tenga consecuencias inesperadas."
                ]
            },
            "3. El Clímax": {
                instrucciones: [
                    "Este es el momento de máxima tensión. El misterio se revela o el peligro ataca. ¡No des respiro al lector (ni a tu protagonista)!",
                    "El protagonista se enfrenta directamente a la fuente del miedo. Describe la lucha, la persecución o el descubrimiento final. El ritmo debe ser frenético.",
                    "El clímax es una revelación que cambia todo lo que el protagonista creía saber. ¿Qué descubre? ¿Quién está detrás de todo? ¿Cuál es el verdadero horror?",
                    "Elige un momento de 'ahora o nunca'. El protagonista debe hacer algo para sobrevivir, para resolver el misterio o para escapar. ¿Qué es lo que arriesga?",
                    "El peligro está en su punto álgido. El protagonista debe ser más inteligente, más rápido o más valiente que lo que sea que le persigue. Describe el momento crucial.",
                    "El clímax no es una acción, es una decisión. El protagonista debe elegir entre dos opciones horribles. ¿Qué elige y por qué?",
                    "La atmósfera debe ser casi insoportable. Usa descripciones sensoriales intensas: el olor a metal, el calor de un fuego, el sonido ensordecedor de un grito.",
                    "El clímax puede ser una batalla no física. Una guerra de ingenio, una confrontación emocional o una carrera contra el tiempo. ¿Qué hace que el protagonista sea digno de ganar?",
                    "Usa los elementos del nudo para resolver el clímax. El objeto, el sonido o la persona que aparecieron antes, ahora tienen un papel crucial en la resolución.",
                    "El protagonista está al borde del abismo, física o mentalmente. Describe el último intento desesperado por sobrevivir o por entender. ¿Funciona o no?"
                ],
                pistas: [
                    "Usa frases cortas y rápidas para acelerar el ritmo. ¡Impacto! ¡Sorpresa! ¡Acción!",
                    "El clímax debe tener consecuencias. El protagonista no debe salir ileso. Deja una cicatriz física o emocional.",
                    "Utiliza el entorno a tu favor. Un pasillo que se derrumba, un objeto que cae, una puerta que se cierra. Que el escenario sea un peligro más.",
                    "Elige un giro de la trama. Algo que el lector no esperaba. Un aliado se convierte en enemigo, el monstruo es en realidad un fantasma, el protagonista es el culpable.",
                    "La lucha debe ser personal. El protagonista no solo lucha por su vida, lucha contra sus propios miedos o contra una injusticia pasada.",
                    "Un clímax puede durar varios párrafos. Juega con la velocidad de la acción y la lentitud de la reflexión para mantener al lector en vilo.",
                    "No te detengas a explicar. El lector debe entender lo que pasa a través de la acción y el diálogo. La explicación viene después.",
                    "Elige un momento clave y descríbelo en cámara lenta. El tiempo se detiene mientras el protagonista toma una decisión vital o ve algo horrible.",
                    "El clímax es el punto más alto del arco de personaje. El protagonista debe usar todo lo que ha aprendido para sobrevivir o fallar.",
                    "Usa las emociones. Miedo, rabia, desesperación, triunfo. Haz que el lector sienta lo mismo que el protagonista en cada momento."
                ]
            },
            "4. El Desenlace": {
                instrucciones: [
                    "¿Cómo termina todo? ¿El protagonista escapa? ¿Resuelve el misterio? ¿O queda atrapado para siempre? Escribe el final de tu historia.",
                    "El protagonista ha sobrevivido. ¿Qué consecuencias ha dejado el clímax en él? ¿Ha cambiado? ¿Qué hace ahora con su vida? Describe su estado mental.",
                    "El misterio ha sido resuelto. El protagonista entiende por qué todo ha pasado. Explica la verdad al lector, pero deja un pequeño cabo suelto para el futuro.",
                    "Un final ambiguo. El protagonista escapa, pero el misterio no se ha resuelto. El lector se queda con la pregunta: ¿Realmente ha escapado?",
                    "El horror persiste. El protagonista creía que había escapado, pero el peligro le sigue. El final es una advertencia, una amenaza o una promesa de una segunda parte.",
                    "El protagonista ha fallado. No ha podido escapar o resolver el misterio. El final es trágico y melancólico, mostrando las consecuencias de su fracaso.",
                    "La vuelta a la normalidad. Después de la experiencia, el protagonista vuelve a su vida, pero no es el mismo. Algo ha cambiado en su percepción de la realidad.",
                    "Un final de sacrificio. El protagonista se sacrifica para salvar a otros o para detener el horror. Describe su último momento y lo que significa para la historia.",
                    "Un final de 'todo fue un sueño'. ¿O no? El protagonista despierta, pero hay un detalle que le hace dudar. Describe este detalle y el horror de la incertidumbre.",
                    "El final es un bucle. El protagonista ha vuelto al principio de la historia, pero con el conocimiento de lo que va a pasar. ¿Cómo reacciona?"
                ],
                pistas: [
                    "Un final puede ser cerrado (todo se resuelve) o abierto (deja una pregunta en el aire). ¡Ambos son válidos en el terror!",
                    "El final debe ser coherente con el tono de la historia. Si es una historia de terror puro, un final feliz puede no ser el adecuado.",
                    "No expliques demasiado. El lector debe ser capaz de entender el final sin una exposición larga y aburrida. 'Show, don't tell' también aplica aquí.",
                    "Cierra todos los cabos sueltos que el lector esperaba. O al menos, los más importantes. Los pequeños detalles pueden quedar en el aire.",
                    "Elige un final impactante. Una última frase, un último sonido, una última imagen que se quede en la mente del lector.",
                    "El final debe mostrar el crecimiento del personaje, o su total destrucción. ¿Ha aprendido la lección? ¿O ha sido vencido por el horror?",
                    "Si el final es abierto, que la pregunta sea interesante. No dejes al lector con una simple falta de información, sino con un misterio que vale la pena pensar.",
                    "Usa un símbolo o un objeto del principio de la historia en el final. ¿Qué significa ahora? ¿Ha cambiado su significado?",
                    "No tengas miedo de un final triste o trágico. A veces, en el terror, no se puede ganar. El fracaso puede ser una historia poderosa.",
                    "El final no tiene que ser el final de la historia, sino el final del viaje del protagonista. ¿Qué pasa después? Eso es para otra historia."
                ]
            }
        };

        // Estado de la aplicación
        let view = 'welcome'; // 'welcome', 'plots', 'writing', 'summary'
        let numPlots = 0;
        let plots = [];
        let spinningIntervals = {};
        let magnifiedPlotIndex = null;
        let currentWritingStep = 0;
        let showTimer = false;
        // Nueva paleta de colores para las tarjetas
        const COLOR_PALETTE = ['border-red-500', 'border-yellow-500', 'border-green-500', 'border-blue-500', 'border-pink-500', 'border-orange-500', 'border-purple-500', 'border-gray-500'];
        let plotColors = [];
        // Nuevo estado para almacenar las instrucciones y pistas generadas para la sesión actual
        let currentWritingSession = [];
        
        let timerPosition = { x: window.innerWidth - 300, y: 50 };

        // Referencia al contenedor principal de la aplicación
        const appContainer = document.getElementById('app');

        // Helper para obtener un color de borde de la paleta
        const getBorderColor = (index) => {
            return COLOR_PALETTE[index % COLOR_PALETTE.length];
        };

        // Renderiza la vista de bienvenida
        const renderWelcomeView = () => {
            appContainer.innerHTML = `
                <div class="container bg-gray-900 text-white">
                    <div class="main-card flex flex-col items-center justify-center mx-auto">
                        <div class="flex items-center justify-center mb-6">
                            <i data-lucide="monitor" class="text-blue-400 mr-4 w-9 h-9"></i>
                            <h1 class="text-3xl font-extrabold text-blue-400">Modo-Live</h1>
                        </div>
                        <p class="text-xl mb-6 text-center">Bienvenidos al modo-live, una actividad de escritura creativa para toda la clase.</p>
                        <p class="text-xl mb-8 text-center">¿Cuántas historias se van a crear?</p>
                        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                            <input type="number" min="1" max="40" value="${numPlots}" id="num-plots-input"
                                class="w-full sm:w-24 text-center p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />
                            <button id="create-plots-btn" class="w-full sm:w-auto px-6 py-3 rounded-lg font-bold text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 transition transform hover:scale-105 shadow-lg">
                                ¡Crear tramas!
                            </button>
                        </div>
                    </div>
                </div>
            `;
            // Vuelve a renderizar los iconos de Lucide
            lucide.createIcons();

            document.getElementById('num-plots-input').addEventListener('input', (e) => {
                numPlots = Math.min(40, Math.max(0, parseInt(e.target.value) || 0));
                document.getElementById('create-plots-btn').disabled = (numPlots < 1 || numPlots > 40);
            });

            document.getElementById('create-plots-btn').addEventListener('click', handleCreatePlots);
        };

        // Renderiza la vista de las tramas
        const renderPlotsView = () => {
            appContainer.innerHTML = `
                <div class="bg-gray-900 min-h-screen p-4 flex flex-col relative">
                    <h2 class="text-white text-3xl font-extrabold text-center mb-6">Trámas Generadas</h2>
                    <div id="plots-container" class="flex-grow grid-plots p-4 lg:p-8 overflow-y-auto">
                        ${plots.map((plot, index) => `
                            <div class="plot-card ${plotColors[index]}" data-index="${index}">
                                <div class="text-xl sm:text-2xl font-bold mb-4">${index + 1}</div>
                                <div class="space-y-2 text-sm sm:text-base md:text-lg text-gray-300">
                                    <div class="bg-gray-700 rounded-lg p-2 spinning-placeholder" id="protagonista-${index}">...</div>
                                    <div class="bg-gray-700 rounded-lg p-2 spinning-placeholder" id="escenario-${index}">...</div>
                                    <div class="bg-gray-700 rounded-lg p-2 spinning-placeholder" id="detonante-${index}">...</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-center p-4">
                        <button id="start-writing-btn" class="px-8 py-4 rounded-full font-bold text-lg text-white bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 transition transform hover:scale-105 shadow-xl">
                            ¡Comenzar a escribir!
                        </button>
                    </div>
                </div>
            `;
            document.querySelectorAll('.plot-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    magnifiedPlotIndex = index;
                    renderMagnifiedPlotOverlay();
                });
            });

            document.getElementById('start-writing-btn').addEventListener('click', () => {
                // Genera las instrucciones y pistas para la sesión de escritura
                currentWritingSession = GUIA_ESCRITURA_STEPS.map(stepTitle => {
                    const opciones = GUIA_ESCRITURA_OPTIONS[stepTitle];
                    return {
                        titulo: stepTitle,
                        instruccion: opciones.instrucciones[Math.floor(Math.random() * opciones.instrucciones.length)],
                        pista: opciones.pistas[Math.floor(Math.random() * opciones.pistas.length)]
                    };
                });
                view = 'writing';
                renderApp();
            });

            // Iniciar el "spinning"
            plots.forEach((plot, index) => {
                setTimeout(() => {
                    spinAndStop(index);
                }, index * 500);
            });
        };

        // Renderiza la vista de la guía de escritura
        const renderWritingView = () => {
            const currentStep = currentWritingSession[currentWritingStep];
            const borderColor = plotColors[magnifiedPlotIndex] || plotColors[0];

            appContainer.innerHTML = `
                <div class="flex flex-col md:flex-row h-screen bg-gray-900 text-white">
                    <!-- Panel lateral de la guía -->
                    <div class="w-full md:w-1/4 p-8 bg-gray-800 shadow-2xl flex flex-col justify-between md:fixed md:top-0 md:left-0 md:bottom-0 overflow-y-auto">
                        <div>
                            <h2 class="text-3xl font-bold mb-6 text-blue-400">Guía de Escritura</h2>
                            <div class="space-y-4">
                                ${GUIA_ESCRITURA_STEPS.map((stepTitle, index) => `
                                    <button data-index="${index}" class="w-full text-left p-4 rounded-lg font-semibold transition text-xl
                                        ${currentWritingStep === index ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}">
                                        ${stepTitle}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="space-y-4 mt-8">
                            <button id="view-summary-btn" class="w-full py-3 rounded-lg font-bold text-white bg-gray-600 hover:bg-gray-700 transition transform hover:scale-105">
                                <i data-lucide="book" class="inline-block mr-2 w-5 h-5"></i>
                                Ver resumen
                            </button>
                            <button id="show-timer-btn" class="w-full py-3 rounded-lg font-bold text-white bg-gray-600 hover:bg-gray-700 transition transform hover:scale-105">
                                <i data-lucide="timer" class="inline-block mr-2 w-5 h-5"></i>
                                Temporizador
                            </button>
                            <button id="go-to-welcome-btn" class="w-full py-3 rounded-lg font-bold text-white bg-red-600 hover:bg-red-700 transition transform hover:scale-105">
                                <i data-lucide="x" class="inline-block mr-2 w-5 h-5"></i>
                                Ir a Estudio
                            </button>
                        </div>
                    </div>

                    <!-- Contenido principal de la guía -->
                    <div class="md:w-3/4 flex-grow p-10 bg-gray-900 flex flex-col md:ml-[25%]">
                        <div class="p-8 rounded-2xl shadow-xl flex-grow flex flex-col justify-between border-4 ${borderColor}">
                            <div>
                                <h3 class="text-5xl sm:text-6xl font-extrabold mb-6 text-white">${currentStep.titulo}</h3>
                                <p class="text-3xl sm:text-4xl mb-8 text-gray-300">${currentStep.instruccion}</p>
                                <div class="flex items-start bg-gray-800 p-6 rounded-lg border-l-4 border-yellow-500">
                                    <span class="text-yellow-400 text-3xl font-bold mr-4">💡</span>
                                    <p class="text-2xl text-gray-300">${currentStep.pista}</p>
                                </div>
                            </div>
                            <div class="flex justify-between mt-8">
                                <button id="prev-writing-step-btn" class="px-6 py-3 rounded-lg font-bold text-white bg-gray-600 hover:bg-gray-700 transition transform hover:scale-105" style="${currentWritingStep === 0 ? 'visibility: hidden;' : ''}">Anterior</button>
                                <button id="next-writing-step-btn" class="px-6 py-3 rounded-lg font-bold text-white bg-blue-500 hover:bg-blue-600 transition transform hover:scale-105">
                                    ${currentWritingStep < GUIA_ESCRITURA_STEPS.length - 1 ? 'Siguiente' : 'Terminar'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            
            if (showTimer) {
                renderTimerOverlay();
            }

            document.querySelectorAll('[data-index]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentWritingStep = parseInt(e.currentTarget.getAttribute('data-index'));
                    renderApp();
                });
            });

            document.getElementById('view-summary-btn').addEventListener('click', () => {
                view = 'summary';
                renderApp();
            });
            document.getElementById('show-timer-btn').addEventListener('click', () => {
                showTimer = !showTimer;
                if (showTimer) {
                    renderTimerOverlay();
                } else {
                    const timerOverlay = document.getElementById('timer-overlay');
                    if (timerOverlay) timerOverlay.remove();
                }
            });
            document.getElementById('go-to-welcome-btn').addEventListener('click', () => {
                view = 'welcome';
                plots = [];
                numPlots = 0;
                magnifiedPlotIndex = null;
                renderApp();
            });
            document.getElementById('prev-writing-step-btn').addEventListener('click', () => {
                if (currentWritingStep > 0) {
                    currentWritingStep--;
                    renderApp();
                }
            });
            document.getElementById('next-writing-step-btn').addEventListener('click', () => {
                if (currentWritingStep < GUIA_ESCRITURA_STEPS.length - 1) {
                    currentWritingStep++;
                    renderApp();
                } else {
                    view = 'plots';
                    renderApp();
                }
            });
        };

        // Renderiza la vista de resumen
        const renderSummaryView = () => {
            appContainer.innerHTML = `
                <div class="min-h-screen bg-gray-900 text-white p-10 flex flex-col">
                    <div class="flex-grow grid md:grid-cols-2 gap-8">
                        ${currentWritingSession.map((step, index) => `
                            <div class="p-6 rounded-2xl shadow-xl flex flex-col justify-between border-4 ${plotColors[index] || 'border-blue-500'}">
                                <div>
                                    <h3 class="text-4xl font-bold mb-4">${step.titulo}</h3>
                                    <p class="text-2xl mb-4 text-gray-300">${step.instruccion}</p>
                                    <div class="flex items-start bg-gray-800 p-3 rounded-lg border-l-4 border-yellow-500">
                                        <span class="text-yellow-400 font-bold mr-2">💡</span>
                                        <p class="text-lg text-gray-400">${step.pista}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-center mt-8">
                        <button id="close-summary-btn" class="px-8 py-4 rounded-full font-bold text-white bg-red-600 hover:bg-red-700 transition transform hover:scale-105 shadow-xl">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('close-summary-btn').addEventListener('click', () => {
                view = 'writing';
                renderApp();
            });
        };

        // Renderiza el overlay de la trama magnificada
        const renderMagnifiedPlotOverlay = () => {
            if (magnifiedPlotIndex === null) return;
            const plot = plots[magnifiedPlotIndex];
            const borderColor = plotColors[magnifiedPlotIndex];

            // Elimina el overlay existente si lo hay
            const existingOverlay = document.getElementById('magnified-plot-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }

            const overlayHtml = document.createElement('div');
            overlayHtml.id = 'magnified-plot-overlay'; // Asigna un ID para poder referenciarlo
            overlayHtml.className = 'fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-75 p-4';
            overlayHtml.innerHTML = `
                <div class="relative p-8 rounded-2xl shadow-2xl max-w-2xl w-full bg-gray-800 text-white border-4 ${borderColor}">
                    <button id="close-magnified-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                        <i data-lucide="x" class="w-8 h-8"></i>
                    </button>
                    <h3 class="text-3xl font-extrabold mb-6 text-center">Trama #${magnifiedPlotIndex + 1}</h3>
                    <div class="space-y-4 text-lg text-gray-300">
                        <div class="bg-gray-700 rounded-lg p-4">
                            <span class="font-bold text-blue-400 block">Protagonista:</span>
                            ${plot.protagonista}
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <span class="font-bold text-green-400 block">Escenario:</span>
                            ${plot.escenario}
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <span class="font-bold text-yellow-400 block">Detonante:</span>
                            ${plot.detonante}
                        </div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button id="prev-plot-btn" class="p-3 rounded-full bg-gray-600 hover:bg-gray-700 transition transform hover:scale-110">
                            <i data-lucide="arrow-left" class="w-6 h-6"></i>
                        </button>
                        <button id="next-plot-btn" class="p-3 rounded-full bg-gray-600 hover:bg-gray-700 transition transform hover:scale-110">
                            <i data-lucide="arrow-right" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlayHtml);
            lucide.createIcons();

            document.getElementById('close-magnified-btn').addEventListener('click', () => {
                magnifiedPlotIndex = null;
                overlayHtml.remove();
            });
            document.getElementById('prev-plot-btn').addEventListener('click', handlePrevPlot);
            document.getElementById('next-plot-btn').addEventListener('click', handleNextPlot);
        };

        // Renderiza el overlay del temporizador
        const renderTimerOverlay = () => {
            const existingTimer = document.getElementById('timer-overlay');
            if (existingTimer) {
                return;
            }

            let minutes = 5;
            let seconds = 0;
            let isRunning = false;
            let timerInterval;

            const updateTimerDisplay = () => {
                const minutesElement = document.getElementById('timer-minutes');
                const secondsElement = document.getElementById('timer-seconds');
                if (minutesElement && secondsElement) {
                    minutesElement.textContent = String(minutes).padStart(2, '0');
                    secondsElement.textContent = String(seconds).padStart(2, '0');
                }
            };

            const startTimer = () => {
                if (isRunning) return;
                isRunning = true;
                timerInterval = setInterval(() => {
                    if (seconds > 0) {
                        seconds--;
                    } else if (minutes > 0) {
                        minutes--;
                        seconds = 59;
                    } else {
                        clearInterval(timerInterval);
                        isRunning = false;
                        document.getElementById('play-icon').classList.remove('hidden');
                        document.getElementById('pause-icon').classList.add('hidden');
                    }
                    updateTimerDisplay();
                }, 1000);
            };

            const stopTimer = () => {
                clearInterval(timerInterval);
                isRunning = false;
            };

            const overlayHtml = document.createElement('div');
            overlayHtml.id = 'timer-overlay';
            overlayHtml.className = 'movable-timer bg-gray-800 bg-opacity-80 border-2 border-blue-600 text-white rounded-xl shadow-2xl p-6 w-80';
            overlayHtml.style.left = `${timerPosition.x}px`;
            overlayHtml.style.top = `${timerPosition.y}px`;
            
            overlayHtml.innerHTML = `
                <button id="close-timer-btn" class="absolute top-2 right-2 text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <h3 class="text-xl font-bold mb-4 text-center">Temporizador</h3>
                <div class="flex justify-center items-center gap-4 mb-4">
                    <!-- Controles para minutos -->
                    <div class="flex flex-col items-center">
                        <div class="flex gap-2">
                            <button id="decrease-minutes-btn" class="text-2xl font-bold p-2 hover:bg-gray-700 rounded-full w-10">-</button>
                            <button id="increase-minutes-btn" class="text-2xl font-bold p-2 hover:bg-gray-700 rounded-full w-10">+</button>
                        </div>
                        <div class="text-6xl font-mono text-center w-24">
                            <span id="timer-minutes">${String(minutes).padStart(2, '0')}</span>
                        </div>
                        <span class="text-gray-400 text-sm">Minutos</span>
                    </div>

                    <div class="text-6xl font-mono">:</div>
                    
                    <!-- Controles para segundos -->
                    <div class="flex flex-col items-center">
                        <div class="flex gap-2">
                            <button id="decrease-seconds-btn" class="text-2xl font-bold p-2 hover:bg-gray-700 rounded-full w-10">-</button>
                            <button id="increase-seconds-btn" class="text-2xl font-bold p-2 hover:bg-gray-700 rounded-full w-10">+</button>
                        </div>
                        <div class="text-6xl font-mono text-center w-24">
                            <span id="timer-seconds">${String(seconds).padStart(2, '0')}</span>
                        </div>
                        <span class="text-gray-400 text-sm">Segundos</span>
                    </div>
                </div>
                <div class="flex justify-center gap-4">
                    <button id="start-pause-btn" class="p-3 rounded-full bg-blue-500 hover:bg-blue-600 transition">
                        <i data-lucide="play" id="play-icon" class="w-6 h-6 ${isRunning ? 'hidden' : ''}"></i>
                        <i data-lucide="pause" id="pause-icon" class="w-6 h-6 ${!isRunning ? 'hidden' : ''}"></i>
                    </button>
                    <button id="reset-btn" class="p-3 rounded-full bg-gray-600 hover:bg-gray-700 transition">
                        <i data-lucide="rotate-ccw" class="w-6 h-6"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(overlayHtml);
            lucide.createIcons();
            updateTimerDisplay();

            document.getElementById('close-timer-btn').addEventListener('click', () => {
                showTimer = false;
                stopTimer();
                overlayHtml.remove();
            });
            document.getElementById('start-pause-btn').addEventListener('click', () => {
                if (isRunning) {
                    stopTimer();
                    document.getElementById('play-icon').classList.remove('hidden');
                    document.getElementById('pause-icon').classList.add('hidden');
                } else {
                    startTimer();
                    document.getElementById('play-icon').classList.add('hidden');
                    document.getElementById('pause-icon').classList.remove('hidden');
                }
            });
            document.getElementById('reset-btn').addEventListener('click', () => {
                stopTimer();
                minutes = 5;
                seconds = 0;
                updateTimerDisplay();
                document.getElementById('play-icon').classList.remove('hidden');
                document.getElementById('pause-icon').classList.add('hidden');
            });
            document.getElementById('increase-minutes-btn').addEventListener('click', () => {
                if (!isRunning && minutes < 99) {
                    minutes++;
                    updateTimerDisplay();
                }
            });
            document.getElementById('decrease-minutes-btn').addEventListener('click', () => {
                if (!isRunning && minutes > 0) {
                    minutes--;
                    updateTimerDisplay();
                }
            });
            document.getElementById('increase-seconds-btn').addEventListener('click', () => {
                if (!isRunning) {
                    seconds = (seconds + 10) % 60;
                    updateTimerDisplay();
                }
            });
            document.getElementById('decrease-seconds-btn').addEventListener('click', () => {
                if (!isRunning) {
                    seconds = (seconds - 10 + 60) % 60;
                    updateTimerDisplay();
                }
            });
            
            // Lógica para arrastrar el temporizador
            let isDragging = false;
            let offset = { x: 0, y: 0 };
            overlayHtml.addEventListener('mousedown', (e) => {
                isDragging = true;
                offset.x = e.clientX - overlayHtml.offsetLeft;
                offset.y = e.clientY - overlayHtml.offsetTop;
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    timerPosition.x = e.clientX - offset.x;
                    timerPosition.y = e.clientY - offset.y;
                    overlayHtml.style.left = `${timerPosition.x}px`;
                    overlayHtml.style.top = `${timerPosition.y}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        };

        // Lógica de la aplicación
        const handleCreatePlots = () => {
            if (numPlots > 0 && numPlots <= 40) {
                plots = Array.from({ length: numPlots }, (_, i) => ({
                    id: i,
                    protagonista: '',
                    escenario: '',
                    detonante: '',
                }));
                plotColors = Array.from({ length: numPlots }, (v, i) => getBorderColor(i));
                view = 'plots';
                renderApp();
            }
        };

        const spinAndStop = (plotId) => {
            spinningIntervals[plotId] = {
                protagonista: setInterval(() => updatePlotContent(plotId, 'protagonista', PROTAGONISTAS), 100),
                escenario: setInterval(() => updatePlotContent(plotId, 'escenario', ESCENARIOS), 100),
                detonante: setInterval(() => updatePlotContent(plotId, 'detonante', DETONANTES), 100),
            };

            setTimeout(() => {
                stopSpinning(plotId);
            }, 7000);
        };

        const stopSpinning = (plotId) => {
            Object.values(spinningIntervals[plotId]).forEach(clearInterval);
            plots = plots.map(p =>
                p.id === plotId
                    ? {
                        ...p,
                        protagonista: PROTAGONISTAS[Math.floor(Math.random() * PROTAGONISTAS.length)],
                        escenario: ESCENARIOS[Math.floor(Math.random() * ESCENARIOS.length)],
                        detonante: DETONANTES[Math.floor(Math.random() * DETONANTES.length)],
                    }
                    : p
            );
            renderPlotsContent(); // Actualiza el contenido de las tarjetas
            delete spinningIntervals[plotId];
        };

        const updatePlotContent = (plotId, key, list) => {
            const element = document.getElementById(`${key}-${plotId}`);
            if (element) {
                element.textContent = list[Math.floor(Math.random() * list.length)];
            }
        };
        
        const renderPlotsContent = () => {
            plots.forEach((plot, index) => {
                const protagEl = document.getElementById(`protagonista-${index}`);
                const escenEl = document.getElementById(`escenario-${index}`);
                const detonEl = document.getElementById(`detonante-${index}`);

                if (protagEl && plot.protagonista) protagEl.textContent = plot.protagonista;
                if (escenEl && plot.escenario) escenEl.textContent = plot.escenario;
                if (detonEl && plot.detonante) detonEl.textContent = plot.detonante;
            });
        };

        const handleNextPlot = () => {
            const existingOverlay = document.getElementById('magnified-plot-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            magnifiedPlotIndex = (magnifiedPlotIndex + 1) % numPlots;
            renderMagnifiedPlotOverlay();
        };

        const handlePrevPlot = () => {
            const existingOverlay = document.getElementById('magnified-plot-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            magnifiedPlotIndex = (magnifiedPlotIndex - 1 + numPlots) % numPlots;
            renderMagnifiedPlotOverlay();
        };

        // Función principal para renderizar la aplicación
        const renderApp = () => {
            // Limpia el contenedor antes de renderizar la nueva vista
            appContainer.innerHTML = '';
            // Cierra overlays si existen
            const overlays = document.querySelectorAll('.fixed.inset-0');
            overlays.forEach(o => o.remove());
            
            switch (view) {
                case 'welcome':
                    renderWelcomeView();
                    break;
                case 'plots':
                    renderPlotsView();
                    break;
                case 'writing':
                    renderWritingView();
                    break;
                case 'summary':
                    renderSummaryView();
                    break;
            }
        };

        // Inicia la aplicación al cargar la página
        window.onload = renderApp;
    </script>
</body>
</html>
